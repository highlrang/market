<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
</head>
<body>
    <script th:inline="javascript">
        function pagination(first_page, size, total_page){ // 현재 페이지는 쿼리 페이지+1로 넘어옴
            var pages = "";
            if(first_page > 1){
                pages += "<input type='button' name='previous' value='이전'>";
            }

            total_page = parseInt(total_page) + 1; // 마지막 페이지 포함이기에 +1
            var end = parseInt(first_page + 10);
            if(end > total_page) {
                end = total_page;
            }

            for(var i=first_page; i<end; i++){
                pages += "<input type='button' name='page' value='" + i + "'";
                if(i == now_page){
                    pages += " class='btn btn-black'";
                }
                pages += ">";
            }

            if(end != total_page) {
                pages += "<input type='button' name='next' value='다음'>";
            }

            $("#pagination").empty();
            $("#pagination").append(pages);
        }

        $(document).ready(function(){
            // 처음에는 nowPage 항상 1
            pagination([[ ${nowPage} ]], [[ ${nowSize} ]], [[ ${totalPage} ]]);

            $("#size").val([[ ${nowSize} ]]).prop("selected", true);
        });

        $(function(){
            $("#size").change(function(){
                var data = {
                    category: $("#category").val(),
                    page: "1", // 이후에 $("#nowPage").val()
                    size: $(this).val()
                };

                $.ajax({
                    type: 'get',
                    url: '/item/list/api',
                    data: data,
                    success: function(data) {
                        console.log(data);

                        var itemList = "";
                        $.each(data["list"], function(index, item){
                            itemList += "<div>"
                                     + "<div>" + item.name + "</div>"
                                     + "<div>" + item.price + "</div>"
                                     + "<div>" + item.stock + "</div>"
                                     + "<div>";
                            $.each(item.photos, function(index, photo){
                                itemList += "<img src='../" + photo.name
                                         + "' alt='" + photo.originName
                                         + "' width='200' height='200'>";
                            });
                            itemList += "</div></div>";
                        });

                        $("#itemList").empty();
                        $("#itemList").append(itemList);

                        pagination(data["nowPage"], data["nowSize"], data["totalPage"]);
                    },
                    error : function(request, status, error) {
                        console.log(request, status, error);
                    }
                });

            });
        });

        $(function(){
            $("input[name='page']").click(function(){
                $("input[name='page']").attr('class', '');
                $(this).attr('class', 'btn btn-black');

                var data = {
                    category: $("#category").val(),
                    page: $(this).val(),
                    size: $("#size").val()
                };

                $.ajax({
                    type: 'get',
                    url: '/item/list/api',
                    data: data,
                    success: function(data) {
                        console.log(data);
                        $("#now_page").val(data["nowPage"]);

                        var itemList = "";
                        $.each(data["list"], function(index, item){
                            itemList += "<div>"
                                     + "<div>" + item.name + "</div>"
                                     + "<div>" + item.price + "</div>"
                                     + "<div>" + item.stock + "</div>"
                                     + "<div>";
                            $.each(item.photos, function(index, photo){
                                itemList += "<img src='../" + photo.name
                                         + "' alt='" + photo.originName
                                         + "' width='200' height='200'>";
                            });
                            itemList += "</div></div>";
                        });

                        $("#itemList").empty();
                        $("#itemList").append(itemList);
                    },
                    error : function(request, status, error) {
                        console.log(request, status, error);
                    }
                });

            });
        });

        $(function(){
            $("input[name='previous']").click(function(){
                var now_page = parseInt($("input[name='page']:first").val()) - 10;
                console.log(now_page);
                pagination(now_page, $("size").val(), $("total_page").val());

                // $("input[name='page']:last").click();
            });

            $("input[name='next']").click(function(){
                var now_page = parseInt($("input[name='page']:last").val()) + 1;
                console.log(now_page);
                pagination(now_page, $("#size").val(), $("#total_page").val());

                // $("input[name='page']:first").click();
            });
        });
    </script>

    <div>
        <select id="size">
            <option value="1">1개(10개)</option>
            <option value="3">3개(20개)</option>
        </select>
    </div>

    <div id="itemList">
    <div th:each="item: ${items}">

        <div th:text="${item.name}"></div>
        <div th:text="|${item.price}원|"></div>
        <div th:text="|수량 ${item.stock}개|"></div>

        <div th:each="photo: ${item.photos}">
            <img th:src="|../${photo.name}|" th:alt="${photo.originName}" width="200" height="200">
        </div>
    </div>
    </div>

    <div>
        <input type="hidden" id="now_page" th:value="${nowPage}">
        <input type="hidden" id="total_page" th:value="${totalPage}">
        <input type="hidden" id="category" th:value="${category}">
    </div>

    <div id="pagination">

    </div>
</body>
</html>